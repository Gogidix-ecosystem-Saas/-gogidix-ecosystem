# =====================================================
# GOGIDIX ECOSYSTEM - INFRASTRUCTURE DRY RUN VALIDATION
# =====================================================
# GitHub Actions workflow for infrastructure validation only
# Tests AWS connectivity, Docker Cloud, and database connectivity
# No actual deployment - validation and testing only
# =====================================================

name: Infrastructure Dry Run Validation

on:
  push:
    branches: [main, develop, staging]
    paths:
      - 'infrastructure/**'
      - 'configs/**'
      - '.github/workflows/infrastructure-dry-run.yml'
  pull_request:
    branches: [main]
    paths:
      - 'infrastructure/**'
      - 'configs/**'
  workflow_dispatch:
    inputs:
      validation_type:
        description: 'Type of validation to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - aws-connectivity
          - docker-cloud
          - database-connectivity
          - security-scan

env:
  AWS_REGION: us-east-1
  DOCKER_CLOUD_REGISTRY: docker.io

jobs:
  # ========================================
  # AWS CONNECTIVITY VALIDATION
  # ========================================
  validate-aws-connectivity:
    name: Validate AWS Connectivity
    runs-on: ubuntu-latest
    if: contains(github.event.inputs.validation_type, 'aws') || github.event.inputs.validation_type == 'all' || github.event.inputs.validation_type == ''

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate AWS Authentication
        run: |
          echo "üîß Validating AWS authentication..."
          aws sts get-caller-identity
          echo "‚úÖ AWS authentication successful"

      - name: Test AWS Services Connectivity
        run: |
          echo "üîß Testing AWS services connectivity..."

          # Test EC2
          echo "Testing EC2 access..."
          aws ec2 describe-instances --max-items 1 --query "Reservations[0].Instances[0].InstanceId" --output text || echo "‚ö†Ô∏è No EC2 instances found"

          # Test ECR (Docker registry)
          echo "Testing ECR access..."
          aws ecr describe-repositories --max-items 1 --query "repositories[0].repositoryName" --output text || echo "‚ö†Ô∏è No ECR repositories found"

          # Test RDS
          echo "Testing RDS access..."
          aws rds describe-db-instances --max-items 1 --query "DBInstances[0].DBInstanceIdentifier" --output text || echo "‚ö†Ô∏è No RDS instances found"

          # Test S3
          echo "Testing S3 access..."
          aws s3 ls || echo "‚ö†Ô∏è No S3 buckets found"

          echo "‚úÖ AWS services connectivity validated"

      - name: Check Account and Region Info
        run: |
          echo "üìä AWS Account Information:"
          aws sts get-caller-identity --query "Account" --output text
          echo "üìç Current Region: ${{ env.AWS_REGION }}"
          echo "üåê Available Regions:"
          aws ec2 describe-regions --query "Regions[].[RegionName]" --output table

  # ========================================
  # DOCKER CLOUD VALIDATION
  # ========================================
  validate-docker-cloud:
    name: Validate Docker Cloud Connectivity
    runs-on: ubuntu-latest
    if: contains(github.event.inputs.validation_type, 'docker') || github.event.inputs.validation_type == 'all' || github.event.inputs.validation_type == ''

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Docker CLI
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Cloud
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Validate Docker Cloud Authentication
        run: |
          echo "üîß Validating Docker Cloud authentication..."
          docker info | grep -E "(Username|Registry)"
          echo "‚úÖ Docker Cloud authentication successful"

      - name: Test Docker Hub Operations
        run: |
          echo "üîß Testing Docker Hub operations..."

          # Test registry connectivity
          docker pull alpine:latest
          echo "‚úÖ Docker pull successful"

          # Test tagging and push (to a test repository)
          docker tag alpine:latest ${{ secrets.DOCKER_USERNAME }}/alpine:test-$(date +%s)
          echo "üè∑Ô∏è Docker tagging successful"

          # List images
          docker images | head -10
          echo "‚úÖ Docker Cloud operations validated"

      - name: Check Docker Cloud Registry Info
        run: |
          echo "üìä Docker Cloud Registry Information:"
          echo "Registry: ${{ env.DOCKER_CLOUD_REGISTRY }}"
          echo "Username: ${{ secrets.DOCKER_USERNAME }}"

          # Try to get user info (this may not work with all token types)
          echo "Checking registry connectivity..."
          docker run --rm --privileged alpine sh -c "apk add --no-cache curl && curl -s https://registry.hub.docker.com/v2/" | head -c 100

  # ========================================
  # DATABASE CONNECTIVITY VALIDATION
  # ========================================
  validate-database-connectivity:
    name: Validate Database Connectivity
    runs-on: ubuntu-latest
    if: contains(github.event.inputs.validation_type, 'database') || github.event.inputs.validation_type == 'all' || github.event.inputs.validation_type == ''
    needs: [validate-aws-connectivity]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Database Clients
        run: |
          echo "üîß Installing database clients..."
          sudo apt-get update

          # PostgreSQL client
          sudo apt-get install -y postgresql-client

          # MongoDB client
          wget -qO - https://www.mongodb.org/static/pgp/server-6.0.asc | sudo apt-key add -
          echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
          sudo apt-get update
          sudo apt-get install -y mongodb-org-shell

          # Redis client
          sudo apt-get install -y redis-tools

          # MySQL client (for compatibility testing)
          sudo apt-get install -y mysql-client

          echo "‚úÖ Database clients installed"

      - name: Test PostgreSQL Connectivity
        run: |
          echo "üîß Testing PostgreSQL connectivity..."

          # Try to connect to known PostgreSQL endpoints or test with local installation
          if command -v psql &> /dev/null; then
            echo "PostgreSQL client available"
            psql --version

            # Test with a local PostgreSQL if available, otherwise show connection format
            if pg_isready -h localhost -p 5432 &> /dev/null; then
              echo "‚úÖ PostgreSQL running locally"
            else
              echo "üìù PostgreSQL connection format for AWS RDS:"
              echo "psql -h <rds-endpoint> -U <username> -d <database> -p 5432"
            fi
          else
            echo "‚ùå PostgreSQL client not available"
          fi

      - name: Test MongoDB Connectivity
        run: |
          echo "üîß Testing MongoDB connectivity..."

          if command -v mongosh &> /dev/null || command -v mongo &> /dev/null; then
            echo "MongoDB client available"
            mongosh --version 2>/dev/null || mongo --version 2>/dev/null

            echo "üìù MongoDB connection format for AWS DocumentDB:"
            echo "mongosh \"mongodb://<username>:<password>@<docdb-endpoint>:27017/<database>?ssl=true\""
          else
            echo "‚ùå MongoDB client not available"
          fi

      - name: Test Redis Connectivity
        run: |
          echo "üîß Testing Redis connectivity..."

          if command -v redis-cli &> /dev/null; then
            echo "Redis client available"
            redis-cli --version

            # Test local Redis if available
            if redis-cli ping &> /dev/null; then
              echo "‚úÖ Redis running locally"
            else
              echo "üìù Redis connection format for AWS ElastiCache:"
              echo "redis-cli -h <elasticache-endpoint> -p 6379 -a <password>"
            fi
          else
            echo "‚ùå Redis client not available"
          fi

      - name: Validate Database Configuration Files
        run: |
          echo "üîß Validating database configuration files..."

          if [ -f "configs/aws-credentials.yaml" ]; then
            echo "‚úÖ AWS credentials configuration found"
            cat configs/aws-credentials.yaml | head -20
          fi

          if [ -f "infrastructure/docker/docker-compose.infrastructure.yml" ]; then
            echo "‚úÖ Docker Compose infrastructure configuration found"
            grep -E "(database|postgres|mongodb|redis)" infrastructure/docker/docker-compose.infrastructure.yml | head -10
          fi

  # ========================================
  # SECURITY AND VALIDATION SCANS
  # ========================================
  security-validation:
    name: Security Validation
    runs-on: ubuntu-latest
    if: contains(github.event.inputs.validation_type, 'security') || github.event.inputs.validation_type == 'all' || github.event.inputs.validation_type == ''

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'infrastructure/'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Validate Configuration Files
        run: |
          echo "üîß Validating configuration files..."

          # Check for sensitive data exposure
          echo "Checking for potential sensitive data in configuration files..."
          if grep -r -i "password\|secret\|key\|token" configs/ infrastructure/ --exclude-dir=.git 2>/dev/null | head -5; then
            echo "‚ö†Ô∏è Potential sensitive data found - ensure these are properly secured"
          else
            echo "‚úÖ No obvious sensitive data found in plaintext"
          fi

          # Validate YAML syntax
          echo "Validating YAML syntax..."
          find configs/ infrastructure/ -name "*.yml" -o -name "*.yaml" | xargs -I {} sh -c 'echo "Checking {}..." && yamllint {} || echo "‚ö†Ô∏è YAML linting issues found in {}"'

  # ========================================
  # VALIDATION SUMMARY
  # ========================================
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-aws-connectivity, validate-docker-cloud, validate-database-connectivity, security-validation]
    if: always()

    steps:
      - name: Prepare Validation Report
        id: report
        run: |
          echo "## Infrastructure Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Validation Job | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          # AWS Connectivity
          if [ "${{ needs.validate-aws-connectivity.result }}" == "success" ]; then
            echo "| AWS Connectivity | ‚úÖ Success | AWS authentication and services working |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| AWS Connectivity | ‚ùå Failed | AWS connectivity issues detected |" >> $GITHUB_STEP_SUMMARY
          fi

          # Docker Cloud
          if [ "${{ needs.validate-docker-cloud.result }}" == "success" ]; then
            echo "| Docker Cloud | ‚úÖ Success | Docker Hub authentication and operations working |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Docker Cloud | ‚ùå Failed | Docker Cloud connectivity issues |" >> $GITHUB_STEP_SUMMARY
          fi

          # Database Connectivity
          if [ "${{ needs.validate-database-connectivity.result }}" == "success" ]; then
            echo "| Database Connectivity | ‚úÖ Success | Database clients installed and connection formats validated |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Database Connectivity | ‚ùå Failed | Database connectivity setup failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Security Validation
          if [ "${{ needs.security-validation.result }}" == "success" ]; then
            echo "| Security Validation | ‚úÖ Success | Security scans completed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Security Validation | ‚ùå Failed | Security validation failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall Status
          if [ "${{ needs.validate-aws-connectivity.result }}" == "success" ] && \
             [ "${{ needs.validate-docker-cloud.result }}" == "success" ] && \
             [ "${{ needs.validate-database-connectivity.result }}" == "success" ] && \
             [ "${{ needs.security-validation.result }}" == "success" ]; then
            echo "üéâ **Overall Status: ALL VALIDATIONS PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure is ready for deployment!" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Overall Status: SOME VALIDATIONS FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review failed validations before proceeding with deployment." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create Validation Issue on Failure
        if: contains(needs.*.result, 'failure')
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Infrastructure Validation Failed',
              body: `## Infrastructure Validation Failure Report

              **Commit:** ${{ github.sha }}
              **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              **Validation Type:** ${{ github.event.inputs.validation_type || 'all' }}
              **Timestamp:** ${{ github.event.head_commit.timestamp }}

              **Failed Validations:**
              - AWS Connectivity: ${{ needs.validate-aws-connectivity.result }}
              - Docker Cloud: ${{ needs.validate-docker-cloud.result }}
              - Database Connectivity: ${{ needs.validate-database-connectivity.result }}
              - Security Validation: ${{ needs.security-validation.result }}

              **Next Steps:**
              1. Review the workflow logs for detailed error messages
              2. Check AWS credentials and permissions
              3. Verify Docker Cloud authentication
              4. Validate database configuration files
              5. Review security scan results

              **Debugging Information:**
              - Branch: ${{ github.ref_name }}
              - Actor: ${{ github.actor }}
              - Environment: Validation (Dry Run)
              `,
              labels: ['bug', 'infrastructure', 'validation-failed']
            })

# ========================================
# WORKFLOW SUMMARY
# ========================================
# This workflow performs dry run validation of:
# 1. AWS connectivity and authentication
# 2. Docker Cloud connectivity and operations
# 3. Database client setup and connection formats
# 4. Security scans and configuration validation
#
# Required GitHub repository secrets:
# - AWS_ACCESS_KEY_ID
# - AWS_SECRET_ACCESS_KEY
# - DOCKER_USERNAME
# - DOCKER_PASSWORD
# ========================================